trigger:
- master

variables:
  sdkVersion: '3.0.100-preview8-013255'
  xfSolution: 'TsinghuaNet.XF.sln'
  libProject: 'TsinghuaNet/TsinghuaNet.csproj'
  cliProject: 'TsinghuaNet.CLI/TsinghuaNet.CLI.csproj'
  wpfProject: 'TsinghuaNet.Eto/TsinghuaNet.Eto.Wpf/TsinghuaNet.Eto.Wpf.csproj'
  gtkProject: 'TsinghuaNet.Eto/TsinghuaNet.Eto.Gtk/TsinghuaNet.Eto.Gtk.csproj'
  macProject: 'TsinghuaNet.Eto/TsinghuaNet.Eto.Mac/TsinghuaNet.Eto.Mac.csproj'
  uwpProject: 'TsinghuaNet.XF/TsinghuaNet.XF.UWP/TsinghuaNet.XF.UWP.csproj'
  droidProject: 'TsinghuaNet.XF/TsinghuaNet.XF.Android/TsinghuaNet.XF.Android.csproj'

jobs:
- job: Linux_CLI
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NET Core SDK 3.0'
    inputs:
      version: '$(sdkVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Restore project'
    inputs:
      projects: '$(cliProject)'
      command: restore
      feedsToUse: config
      nugetConfigPath: NuGet.Config
      
  - script: |
      wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
      sudo apt-add-repository "deb https://apt.llvm.org/xenial/ llvm-toolchain-xenial-3.9 main"
      sudo apt -o Acquire::AllowInsecureRepositories=true update && sudo apt-get install clang-3.9 lldb-3.9 comerr-dev krb5-multidev libgssrpc4 libkadm5clnt-mit9 libkadm5srv-mit9 libkdb5-8 libkrb5-dev
      sudo ln /usr/lib/x86_64-linux-gnu/libgssapi_krb5.so.2 /usr/lib/libgssapi_krb5.so
    displayName: 'Install clang-3.7'

  - script: dotnet publish $(cliProject) -r linux-x64 -c Release -o build/linux-x64
    displayName: 'Publish project'

  - script: strip build/linux-x64/TsinghuaNet.CLI
    displayName: 'Strip'

  - script: rm build/linux-x64/*.pdb
    displayName: 'Remove PDBs'

  - script: rm build/linux-x64/*.json
    displayName: 'Remove JSONs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build/linux-x64'
      includeRootFolder: false
      archiveType: 'tar'
      tarCompression: 'gz'
      archiveFile: '$(Build.ArtifactStagingDirectory)/TsinghuaNet.CLI.Linux64.tar.gz'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: MacOS_CLI
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NET Core SDK 3.0'
    inputs:
      version: '$(sdkVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Restore project'
    inputs:
      projects: '$(cliProject)'
      command: restore
      feedsToUse: config
      nugetConfigPath: NuGet.Config

  - script: dotnet publish $(cliProject) -r osx-x64 -c Release -o build/osx-x64
    displayName: 'Publish project'
  
  - script: strip build/osx-x64/TsinghuaNet.CLI
    displayName: 'Strip'

  - script: rm build/osx-x64/*.pdb
    displayName: 'Remove PDBs'

  - script: rm build/osx-x64/*.json
    displayName: 'Remove JSONs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build/osx-x64'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/TsinghuaNet.CLI.OSX64.zip'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: Windows_CLI
  pool:
    vmImage: 'windows-2019'
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NET Core SDK 3.0'
    inputs:
      version: '$(sdkVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Restore project'
    inputs:
      projects: '$(cliProject)'
      command: restore
      feedsToUse: config
      nugetConfigPath: NuGet.Config

  - script: dotnet publish $(cliProject) -r win-x64 -c Release -o build\win-x64
    displayName: 'Publish project'

  - script: del build\win-x64\*.pdb
    displayName: 'Remove PDBs'

  - script: del build\win-x64\*.json
    displayName: 'Remove JSONs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build\win-x64'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\TsinghuaNet.CLI.Win64.zip'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: Windows_Eto
  pool:
    vmImage: 'windows-2019'
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NET Core SDK 3.0'
    inputs:
      version: '$(sdkVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Restore project'
    inputs:
      projects: '$(wpfProject)'
      command: restore
      feedsToUse: config
      nugetConfigPath: NuGet.Config
  
  - script: dotnet publish $(wpfProject) -r win-x64 -c Release -f net48 -o build\eto.wpf\net48
    displayName: 'Publish project as net48'

  - script: del build\eto.wpf\net48\*.pdb
    displayName: 'Remove PDBs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build\eto.wpf\net48'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\TsinghuaNet.Eto.Wpf.Fx.zip'

  - script: dotnet publish $(wpfProject) -r win-x64 -f netcoreapp3.0 --self-contained false -o build\eto.wpf\netcoreapp3.0\dep
    displayName: 'Publish project as netcoreapp3.0 FDE'

  - script: del build\eto.wpf\netcoreapp3.0\dep\*.pdb
    displayName: 'Remove PDBs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build\eto.wpf\netcoreapp3.0\dep'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\TsinghuaNet.Eto.Wpf.CoreFx.Dependent.zip'

  - script: dotnet publish $(wpfProject) -r win-x64 -f netcoreapp3.0 -o build\eto.wpf\netcoreapp3.0\self /p:PublishTrimmed=true
    displayName: 'Publish project as netcoreapp3.0 SCE'

  - script: del build\eto.wpf\netcoreapp3.0\self\*.pdb
    displayName: 'Remove PDBs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build\eto.wpf\netcoreapp3.0\self'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\TsinghuaNet.Eto.Wpf.CoreFx.Self.zip'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: Linux_Eto
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NET Core SDK 3.0'
    inputs:
      version: '$(sdkVersion)'

  - task: DotNetCoreCLI@2
    displayName: 'Restore project'
    inputs:
      projects: '$(gtkProject)'
      command: restore
      feedsToUse: config
      nugetConfigPath: NuGet.Config
  
  - script: dotnet publish $(gtkProject) -r linux-x64 -c Release --self-contained false -o build/eto.gtk/dep
    displayName: 'Publish project as FDE'

  - script: rm build/eto.gtk/dep/*.pdb
    displayName: 'Remove PDBs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build/eto.gtk/dep'
      includeRootFolder: false
      archiveType: 'tar'
      tarCompression: 'gz'
      archiveFile: '$(Build.ArtifactStagingDirectory)/TsinghuaNet.Eto.Gtk.Dependent.tar.gz'

  - script: dotnet publish $(gtkProject) -r linux-x64 -c Release -o build/eto.gtk/self /p:PublishTrimmed=true
    displayName: 'Publish project as SCE'

  - script: rm build/eto.gtk/self/*.pdb
    displayName: 'Remove PDBs'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build/eto.gtk/self'
      includeRootFolder: false
      archiveType: 'tar'
      tarCompression: 'gz'
      archiveFile: '$(Build.ArtifactStagingDirectory)/TsinghuaNet.Eto.Gtk.Self.tar.gz'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: Windows_XF_UWP
  pool:
    vmImage: 'windows-2019'
  steps:
  - task: NuGetToolInstaller@0
    displayName: 'Install NuGet 5.1.0'
    inputs:
      versionSpec: '5.1.0'
  
  - task: NuGetCommand@2
    displayName: 'Restore solution'
    inputs:
      restoreSolution: '$(xfSolution)'
      feedsToUse: config
      nugetConfigPath: 'NuGet.Config'

  - task: MSBuild@1
    displayName: 'Build app bundle'
    inputs:
      solution: '$(uwpProject)'
      configuration: 'Release'
      msbuildArguments: '/p:AppxBundlePlatforms="x86|x64" /p:AppxPackageDir="..\..\build\uwp\AppxPackages" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=SideloadOnly'

  - pwsh: rm build/uwp/AppxPackages/*/*/ARM* -Force -Recurse
    displayName: 'Remove ARM/ARM64 dependencies'

  - task: ArchiveFiles@2
    displayName: 'Archive'
    inputs:
      rootFolderOrFile: 'build\uwp\AppxPackages'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\TsinghuaNet.XF.UWP.zip'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'

- job: Windows_XF_Android
  pool:
    vmImage: 'windows-2019'
  variables:
    ANDROID_NDK_HOME: C:\Microsoft\AndroidNDK64\android-ndk-r16b
    ANDROID_NDK_PATH: C:\Microsoft\AndroidNDK64\android-ndk-r16b
    AndroidNdkDirectory: C:\Microsoft\AndroidNDK64\android-ndk-r16b
  steps:
  - task: NuGetToolInstaller@0
    displayName: 'Install NuGet 5.1.0'
    inputs:
      versionSpec: '5.1.0'

  - task: NuGetCommand@2
    displayName: 'Restore solution'
    inputs:
      restoreSolution: '$(xfSolution)'
      feedsToUse: config
      nugetConfigPath: 'NuGet.Config'

  - task: MSBuild@1
    displayName: 'Build apk'
    inputs:
      solution: '$(droidProject)'
      configuration: 'Release'
      msbuildArguments: '/r /t:SignAndroidPackage /p:JavaSdkDirectory="%JAVA_HOME%" /p:AndroidSigningKeyPass=$(key-password) /p:AndroidSigningStorePass=$(keystore-password)'

  - task: CopyFiles@2
    displayName: 'Publish Android Binaries'
    inputs:
      SourceFolder: $(build.sourcesdirectory)/TsinghuaNet.XF/TsinghuaNet.XF.Android/bin/Release
      Contents: '**/*-Signed.apk'
      TargetFolder: $(build.artifactstagingdirectory)
      CleanTargetFolder: false
      OverWrite: false
      flattenFolders: false

  - task: PublishBuildArtifacts@1
    displayName: 'Publish'
    inputs:
      artifactName: 'publish'
